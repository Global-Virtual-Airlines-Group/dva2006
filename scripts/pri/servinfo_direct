#!/bin/bash
# ServInfo direct download script
# (c) 2006, 2009, 2010, 2012, 2015, 2016, 2019 Global Virtual Airlines Group. All Rights Reserved.

function log {
 logTime=$(date +'%m/%d/%Y %H:%M:%S')
 echo "$logTime $1"
}

# Set the file to download to
if [ -z "$2" ]; then
 echo "servinfo <network> <path> [verbose] ..."
 exit 1
fi

# Turn on verbose operation if requested
QuietOpt=""
if [ -z "$3" ]; then
 QuietOpt="-q"
fi

# Get the status URL
if [ "PilotEdge" == "$1" ]; then
 MyURL="http://map.pilotedge.net/vspro.dat"
 InfoFile="vspro.dat"
 network="pilotedge"
else
 log "Unknown network - $1"
 exit 3
fi

# Check if we're already downloading or reading
if [ -f "/tmp/$network.isactive" ]; then
 log "$network data is busy!"
 sleep 1.5
 if [ -f "/tmp/$network.isactive" ]; then
  log "Already downloading $network data!"
  exit 2
 else
  echo active > /tmp/$network.isactive
 fi
else
 echo active > /tmp/$network.isactive
fi

# Make path
mkdir /tmp/$network
cd /tmp/$network

# Get the info file
LastMod=1
if [ -f "$2/$network.info" ]; then
 cp $2/$network.info /tmp/$network/$InfoFile
 touch -r $2/$network.info /tmp/$network/$InfoFile
 LastMod=$(stat -c %Y /tmp/$network/$InfoFile)
fi
wget $MyURL -N --timeout=10 --tries=5 $QuietOpt
if [ -f "/tmp/$network/$InfoFile" ]; then
 LastModDL=$(stat -c %Y /tmp/$network/$InfoFile)
 if [ "$LastMod" -ge "$LastModDL" ]; then
  log "Downloaded file is same/older!"
 else
  cp /tmp/$network/$InfoFile $2/$network.info
  touch -r /tmp/$network/$InfoFile $2/$network.info
  ValidTime=$(grep "UPDATE = " $2/$network.info | cut -d' ' -f 3)
  wget -O /dev/null -q --timeout=5 --tries=3 "https://www.deltava.org/networkpull.ws?net=$network&d=$ValidTime"
 fi 
else
 log "Invalid $network traffic data!"
fi

# Clean up temp files
cd /tmp
rm -r /tmp/$network
rm $network.isactive
exit 0
